{% extends "clinic/base.html" %}
{% load static %}

{% block title %}
{% if form.instance.pk %}
Editar Consulta - OdontoIA
{% else %}
Nova Consulta - OdontoIA
{% endif %}
{% endblock %}

{% block content %}

<h2 class="page-title text-center my-3">
    {% if form.instance.pk %}
    ‚úèÔ∏è Editar Consulta
    {% else %}
    ü¶∑ Agendar Nova Consulta
    {% endif %}
</h2>

<form method="post" class="container">
    {% csrf_token %}

    <div class="consulta-card">
        <div class="row g-3">

            <!-- Paciente -->
            <div class="col-12">
                <label for="{{ form.paciente.id_for_label }}" class="form-label">Paciente</label>
                {{ form.paciente }}
            </div>

            <!-- Dentista -->
            <div class="col-md-6">
                <label for="{{ form.dentista.id_for_label }}" class="form-label">Dentista</label>
                {{ form.dentista }}
            </div>

            <!-- Procedimento -->
            <div class="col-md-6">
                <label for="id_procedimento" class="form-label">Procedimento</label>
                <select name="{{ form.procedimento.name }}" id="id_procedimento" class="form-select">
                    <option value="">---------</option>

                    {% for proc in form.fields.procedimento.queryset %}
                    <option value="{{ proc.id }}" data-valor="{{ proc.valor }}" {% if form.instance.pk and
                        form.instance.procedimento and form.instance.procedimento.id==proc.id %} selected {% endif %}>
                        {{ proc.nome }} - R$ {{ proc.valor|floatformat:2 }}
                    </option>
                    {% endfor %}
                </select>

            </div>

            <!-- Data -->
            <div class="col-md-6">
                <label for="{{ form.data.id_for_label }}" class="form-label">Data</label>
                {{ form.data }}
            </div>

            <!-- Valor -->
            <div class="col-md-3">
                <label for="{{ form.valor.id_for_label }}" class="form-label">Valor (R$)</label>
                {{ form.valor }}

            </div>

            <!-- Desconto -->
            <div class="col-md-3">
                <label for="{{ form.desconto.id_for_label }}" class="form-label">Desconto (R$)</label>
                {{ form.desconto }}
                <small class="text-muted">Desconto em reais</small>
            </div>

            <!-- Conclu√≠da / Paga -->
            <div class="col-md-6 d-flex align-items-center gap-3 mt-2">
                <div class="form-check">
                    {{ form.concluida }}
                    <label class="form-check-label" for="{{ form.concluida.id_for_label }}">Conclu√≠da</label>
                </div>
                <div class="form-check">
                    {{ form.paga }}
                    <label class="form-check-label" for="{{ form.paga.id_for_label }}">Paga</label>
                </div>
            </div>

            <!-- Observa√ß√µes -->
            <div class="col-12">
                <label for="{{ form.observacoes.id_for_label }}" class="form-label">Observa√ß√µes</label>
                {{ form.observacoes }}
            </div>

        </div>

        <!-- CARD DE VALOR FINAL -->
        <div class="valor-final-card mt-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1">Valor final da consulta</h5>
                    <small class="text-light opacity-75">
                        Calculado automaticamente: Valor ‚Äì Desconto
                    </small>
                </div>
                <div class="valor-final-valor">
                    R$ <span id="valor-final-label">0,00</span>
                </div>
            </div>
        </div>

        <!-- Bot√µes -->
        <div class="mt-4 text-end">
            <button type="submit" class="btn btn-primary">üíæ Salvar</button>
            <a href="{% url 'clinic:consultas_list' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </div>
</form>

<style>
    .consulta-card {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        max-width: 800px;
        margin: 30px auto;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .page-title {
        color: #0b5394;
        font-weight: 600;
    }

    .btn-primary {
        background-color: #0b5394;
        border: none;
    }

    .btn-primary:hover {
        background-color: #083b6b;
    }

    /* Card de Valor Final */
    .valor-final-card {
        background: linear-gradient(135deg, #2e7d32, #43a047);
        color: #fff;
        border-radius: 14px;
        padding: 16px 20px;
        box-shadow: 0 4px 12px rgba(46, 125, 50, 0.35);
    }

    .valor-final-valor {
        font-size: 1.8rem;
        font-weight: 700;
        letter-spacing: 0.03em;
    }

    @media (max-width: 768px) {
        .consulta-card {
            margin: 10px auto 30px auto;
            padding: 15px;
        }

        .valor-final-valor {
            font-size: 1.5rem;
        }
    }
</style>

<script>
    // ------- Auto preencher VALOR a partir do texto do procedimento -------
    // Ex: "Aparelho ortod√¥ntico invis√≠vel - R$ 1750,00"

    document.addEventListener("DOMContentLoaded", function () {

        const selectProced = document.getElementById("id_procedimento");
        const inputValor = document.getElementById("id_valor");
        const inputDesconto = document.getElementById("id_desconto");
        const spanValorFinal = document.getElementById("valor-final-label");

        function formatarBR(num) {
            return num.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
        }

        function atualizarValor() {
            const opt = selectProced.options[selectProced.selectedIndex];
            if (!opt) return;

            const valor = parseFloat(opt.dataset.valor || 0);

            // Preencher automaticamente o input
            inputValor.value = formatarBR(valor);

            atualizarValorFinal();
        }

        function atualizarValorFinal() {
            const v = parseFloat(inputValor.value.replace(/\./g, "").replace(",", ".") || 0);
            const d = parseFloat(inputDesconto.value.replace(/\./g, "").replace(",", ".") || 0);
            const total = Math.max(v - d, 0);

            spanValorFinal.textContent = formatarBR(total);
        }

        selectProced.addEventListener("change", atualizarValor);
        inputValor.addEventListener("input", atualizarValorFinal);
        inputDesconto.addEventListener("input", atualizarValorFinal);

        atualizarValor();
    });
</script>

{% endblock %}