{% extends "clinic/base.html" %}
{% load static %}

{% block title %}
{% if form.instance.pk %}
Editar Consulta - OdontoIA
{% else %}
Nova Consulta - OdontoIA
{% endif %}
{% endblock %}

{% block content %}

<h2 class="page-title text-center my-3">
    {% if form.instance.pk %}
        ‚úèÔ∏è Editar Consulta
    {% else %}
        ü¶∑ Agendar Nova Consulta
    {% endif %}
</h2>

<form method="post" class="container">
    {% csrf_token %}

    <div class="consulta-card">
        <div class="row g-3">

            <div class="col-12">
                <label class="form-label">Paciente</label>
                {{ form.paciente }}
            </div>

            <div class="col-md-6">
                <label class="form-label">Dentista</label>
                {{ form.dentista }}
            </div>

            <div class="col-md-6">
                <label class="form-label">Procedimento</label>
                {{ form.procedimento }}
            </div>

            <div class="col-md-6">
                <label class="form-label">Data</label>
                {{ form.data }}
            </div>

            <!-- üî• VALOR CORRIGIDO COM ID MANUAL -->
            <div class="col-md-3">
                <label class="form-label" for="id_valor">Valor</label>

                <input type="number" step="0.01"
                       id="id_valor"
                       name="valor"
                       class="form-control"
                       value="{{ form.instance.valor|default_if_none:'' }}">
            </div>

            <div class="col-md-3">
                <label class="form-label">Desconto</label>
                {{ form.desconto }}
                <small class="text-muted">Desconto em R$</small>
            </div>

            <div class="col-md-6 d-flex align-items-center gap-3 mt-2">
                <div class="form-check">
                    {{ form.concluida }}
                    <label class="form-check-label">Conclu√≠da</label>
                </div>

                <div class="form-check">
                    {{ form.paga }}
                    <label class="form-check-label">Paga</label>
                </div>
            </div>

            <div class="col-12">
                <label class="form-label">Observa√ß√µes</label>
                {{ form.observacoes }}
            </div>

        </div>

        <div class="mt-4 text-end">
            <button type="submit" class="btn btn-primary">üíæ Salvar</button>
            <a href="{% url 'clinic:consultas_list' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </div>
</form>

<style>
    .consulta-card {
        background:#fff;
        padding:20px;
        border-radius:12px;
        max-width:700px;
        margin:30px auto;
        box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    .page-title {
        color:#0b5394;
    }
    .btn-primary {
        background-color:#0b5394;
        border:none;
    }
    .btn-primary:hover {
        background-color:#083b6b;
    }
</style>

<!-- üî• JAVASCRIPT 100% FUNCIONAL -->
<script>
document.addEventListener("DOMContentLoaded", function() {

    const selectProced = document.getElementById("id_procedimento");
    const inputValor   = document.getElementById("id_valor");

    if (!selectProced || !inputValor) return;

    function atualizarValor() {
        const opt = selectProced.options[selectProced.selectedIndex];
        if (!opt) return;

        const texto = opt.text || "";
        // pega valor ap√≥s "R$"
        const match = texto.match(/R\$\s*([\d\.\,]+)/);

        if (match) {
            let v = match[1]
                .replace(/\./g, "")  // remove pontos de milhar
                .replace(",", ".");  // transforma v√≠rgula em ponto
            inputValor.value = v;
        }
    }

    atualizarValor(); // ao carregar
    selectProced.addEventListener("change", atualizarValor);
});
</script>

{% endblock %}
